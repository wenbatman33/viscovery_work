
$(document).ready( function()   {

    // requires global variables
    // notifier_url: specify the notifier url
    // isLiteVersion: true if it's lite verion


    var resultElement = document.getElementById('result'),
        client = io( notifier_url ),
        clientid = null;

    client.on('register', function(id) {
        // obtain current browser's client id
        clientid = id;
    });

    client.on('notify', function(result) {
        // display text received from notifier
        var r_list = result.split("\n");
        resultElement.innerHTML = '';
        for (var r=0; r<r_list.length; r++)
            resultElement.innerHTML += r_list[r] + '<br/>';
        // if it's task done, redirect to result page
        if( r_list[0] == "Task done." )
            window.location.href = window.location.origin + '/inspect_job?targetid=' + r_list[1];
    });

    // on clicking the "classify" button, send a POST to server.py
    document.getElementById("classifyurl").onclick = function() {
        var request = new XMLHttpRequest();
        request.open('POST', '/classify_url', true);
        request.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded; charset=utf-8');
        request.onload = function() {
            resultElement.textContent = request.responseText;
            document.getElementById("fullScreenLoading").style.display = "block";
            ////////////////////////////////////
            ///// Add only for FrontEndDev /////
            ////////////////////////////////////
            var r_list = request.responseText.split("\n");
            // if it's task done, redirect to result page
            if( r_list[0] == "Task done." ){
                document.getElementById("fullScreenLoading").style.display = "none";
                window.location.href = window.location.origin + '/inspect_job?targetid=' + r_list[1];
            }else{
                console.log("error");
                
                document.getElementById("loadingBtnWrap").style.display = "block";
                document.getElementById("loadingBtn").onclick = function () {
                    document.getElementById("fullScreenLoading").style.display = "none";
                }
            }
            ////////////////////////////////////
            ///// End only for FrontEndDev /////
            ////////////////////////////////////
        };
        if( ! isLiteVersion )
            request.send('clientid=' + clientid + '&targeturl=' + encodeURIComponent(document.getElementById("targeturl").value) + '&isDebug=' + $('#toggle_debug').prop('checked').toString());
        else
            request.send('clientid=' + clientid + '&targeturl=' + encodeURIComponent(document.getElementById("targeturl").value) + '&isDebug=false');
    };

    // on clicking examples
    // document.getElementById("example_img").onclick = function() {
    //     document.getElementById("targeturl").value = 'http://twimg.edgesuite.net/images/ReNews/20140828/640_71d0c16c7ff2546d64bf471e68e4d37c.jpg';
    //     document.getElementById("classifyurl").click();
    // }
    // document.getElementById("example_vid").onclick = function() {
    //     document.getElementById("targeturl").value = 'https://v.qq.com/x/page/m03878gky0y.html';
    //     document.getElementById("classifyurl").click();
    // }

    // trigger the enter key as a click event
    document.getElementById("targeturl")
        .addEventListener("keypress", function(event) {
            if (event.keyCode == 13) {
                event.preventDefault();
                document.getElementById("classifyurl").click();
            }
    });

});
